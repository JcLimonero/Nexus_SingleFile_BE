
<div class="w-full p-6 space-y-4">
              <!-- Filtros unificados -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 w-full">
                <div class="flex items-center justify-between gap-4 w-full">
                  <!-- Filtro por Agencia -->
                  <div class="flex items-center space-x-4">
                    <mat-form-field appearance="outline" class="min-w-48">
                      <mat-label>Agencia</mat-label>
                      <mat-select 
                        [value]="selectedAgencyId" 
                        (selectionChange)="onAgencyChange($event.value)"
                        [disabled]="loading || !hasAgencies()">
                        <mat-option [value]="null">Todas las agencias</mat-option>
                        <mat-option 
                          *ngFor="let agency of agencies; trackBy: trackByAgencyId" 
                          [value]="agency.Id">
                          {{ agency.Name }}
                        </mat-option>
                      </mat-select>
                      <mat-hint *ngIf="loading">Cargando...</mat-hint>
                      <mat-hint *ngIf="!loading && !hasAgencies()">Sin agencias</mat-hint>
                    </mat-form-field>

                    <!-- Filtro por Usuario -->
                    <mat-form-field appearance="outline" class="min-w-96">
                      <mat-label>Usuario</mat-label>
                      <mat-select 
                        #userSelect
                        [value]="selectedUserId" 
                        (selectionChange)="onUserChange($event.value)"
                        [disabled]="loading || !hasUsers() || isUserFilterDisabled">
                        <mat-option [value]="null">Todos los usuarios</mat-option>
                        <mat-option 
                          *ngFor="let user of users; trackBy: trackByUserId" 
                          [value]="user.Id">
                          {{ user.Name }}
                        </mat-option>
                      </mat-select>
                      <mat-hint *ngIf="loading">Cargando...</mat-hint>
                      <mat-hint *ngIf="!loading && !hasUsers()">Sin usuarios</mat-hint>
                      <mat-hint *ngIf="isUserFilterDisabled">Filtro deshabilitado para su rol</mat-hint>
                    </mat-form-field>
                  </div>
                  
                  <!-- Filtros de Fechas -->
                  <div class="flex items-center space-x-2">
                    <!-- Botones de rangos rápidos -->
                    <div class="flex flex-wrap gap-1">
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === '7d'"
                        (click)="setLast7Days()">
                        7d
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === '30d'"
                        (click)="setLast30Days()">
                        30d
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === '90d'"
                        (click)="setLast90Days()">
                        90d
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === 'thisMonth'"
                        (click)="setThisMonth()">
                        Este mes
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === 'lastMonth'"
                        (click)="setLastMonth()">
                        Mes pasado
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === 'thisYear'"
                        (click)="setThisYear()">
                        Este año
                      </button>
                    </div>
                    
                    <!-- Botón toggle para fechas manuales -->
                    <button 
                      mat-icon-button 
                      size="small"
                      class="toggle-button"
                      (click)="toggleManualDateInputs()"
                      [matTooltip]="showManualDateInputs ? 'Ocultar fechas manuales' : 'Mostrar fechas manuales'">
                      <mat-icon class="arrow-icon" [class.expanded]="showManualDateInputs">
                        {{ showManualDateInputs ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}
                      </mat-icon>
                    </button>
                    
                    <!-- Botón buscar -->
                    <button 
                      mat-icon-button 
                      color="primary" 
                      size="small"
                      (click)="searchData()"
                      matTooltip="Buscar con filtros actuales">
                      <mat-icon>search</mat-icon>
                    </button>
                    
                    <!-- Botón limpiar fechas -->
                    <button 
                      *ngIf="hasDateRange()"
                      mat-icon-button 
                      color="warn" 
                      size="small"
                      (click)="clearDateRange()"
                      matTooltip="Limpiar filtro de fechas">
                      <mat-icon>clear</mat-icon>
                    </button>
                    
                    <!-- Botón limpiar agencia -->
                    <button 
                      *ngIf="selectedAgencyId"
                      mat-icon-button 
                      color="warn" 
                      size="small"
                      (click)="clearAgencyFilter()"
                      matTooltip="Limpiar filtro de agencia">
                      <mat-icon>clear</mat-icon>
                    </button>
                    
                    <!-- Botón limpiar usuario -->
                    <button 
                      *ngIf="selectedUserId"
                      mat-icon-button 
                      color="warn" 
                      size="small"
                      (click)="clearUserFilter()"
                      matTooltip="Limpiar filtro de usuario">
                      <mat-icon>clear</mat-icon>
                    </button>
                    
                    <!-- Botón limpiar todo -->
                    <button 
                      *ngIf="hasAnyFilter()"
                      mat-icon-button 
                      color="warn" 
                      size="small"
                      (click)="clearAllFilters()"
                      matTooltip="Limpiar todos los filtros">
                      <mat-icon>refresh</mat-icon>
                    </button>
                  </div>
                </div>
                
                <!-- Selectores de fecha manuales (se muestran cuando showManualDateInputs es true) -->
                <div *ngIf="showManualDateInputs" class="grid grid-cols-2 gap-2 mt-4 manual-date-inputs">
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Inicio</mat-label>
                    <input 
                      matInput 
                      [matDatepicker]="startPicker"
                      formControlName="startDate"
                      placeholder="Fecha inicio">
                    <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker></mat-datepicker>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Fin</mat-label>
                    <input 
                      matInput 
                      [matDatepicker]="endPicker"
                      formControlName="endDate"
                      placeholder="Fecha fin">
                    <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker></mat-datepicker>
                  </mat-form-field>
                </div>
              </div>

  <!-- Estado de carga -->
  <div *ngIf="loading" class="flex justify-center py-12">
    <div class="text-center">
      <mat-icon class="text-4xl text-gray-400 mb-4" svgIcon="mat:hourglass_empty"></mat-icon>
      <p class="text-gray-600">Cargando datos de analytics...</p>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
    <mat-icon class="text-red-500 mb-2" svgIcon="mat:error"></mat-icon>
    <p class="text-red-600">{{ error }}</p>
    <button mat-button color="primary" (click)="loadDashboardData()">
      Reintentar
    </button>
  </div>

  <!-- Dashboard principal -->
  <div *ngIf="!loading && !error">
    <!-- Métricas específicas de agencia y expedientes liberados -->
    <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-6">
      <!-- Métricas específicas de agencia (solo aplica filtro de agencia) - 3 columnas -->
      <div class="lg:col-span-3">
        <vex-widget-agency-metrics 
          [agencyId]="selectedAgencyId"></vex-widget-agency-metrics>
      </div>

      <!-- Widget de Expedientes Liberados del Mes Actual - 1 columna -->
      <div class="lg:col-span-1">
        <vex-widget-current-month-liberated 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"></vex-widget-current-month-liberated>
      </div>

      <!-- Widget de Expedientes Liberados Totales - 1 columna -->
      <div class="lg:col-span-1">
        <vex-widget-total-liberated 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"></vex-widget-total-liberated>
      </div>

      <!-- Widget de Usuarios de la Agencia - 1 columna -->
      <div class="lg:col-span-1">
        <vex-widget-agency-users 
          [agencyId]="selectedAgencyId"></vex-widget-agency-users>
      </div>
    </div>

  <!-- Gráfico de tendencia de expedientes -->
    <vex-widget-trend-chart 
      [agencyId]="selectedAgencyId" 
      [userId]="selectedUserId"
      class="mb-6"></vex-widget-trend-chart>

    <!-- Widgets de Distribución en la misma fila -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Distribución de expedientes por proceso -->
      <vex-widget-process-distribution 
        [agencyId]="selectedAgencyId" 
        [userId]="selectedUserId"></vex-widget-process-distribution>

      <!-- Métricas de distribución de expedientes -->
      <vex-widget-distribution-metrics-donut 
        [agencyId]="selectedAgencyId"></vex-widget-distribution-metrics-donut>
    </div>

    <!-- Widgets de Estatus en la misma fila -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Distribución de expedientes por estatus -->
      <vex-widget-status-distribution 
        [agencyId]="selectedAgencyId" 
        [userId]="selectedUserId"></vex-widget-status-distribution>

      <!-- Distribución de expedientes por estatus - Mes Actual -->
      <vex-widget-current-month-status 
        [agencyId]="selectedAgencyId" 
        [userId]="selectedUserId"></vex-widget-current-month-status>

      <!-- Widget de Estatus Histórico -->
      <vex-widget-historical-status 
        [agencyId]="selectedAgencyId" 
        [userId]="selectedUserId"></vex-widget-historical-status>
    </div>

        <!-- Widget de Distribución por Asesor -->
        <vex-widget-advisor-distribution 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"
          class="mb-6"></vex-widget-advisor-distribution>

        <!-- Widget de Expedientes por Día - Semana Actual -->
        <vex-widget-weekly-chart 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"
          class="mb-6"></vex-widget-weekly-chart>

        <!-- Widget de Período de Atención de Expedientes -->
        <vex-widget-attention-period 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"
          class="mb-6"></vex-widget-attention-period>

        <!-- Widget de Período de Atención - Mes Actual -->
        <vex-widget-current-month-attention 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"
          class="mb-6"></vex-widget-current-month-attention>

    <!-- Widget de Meses Anteriores - OCULTO -->
    <!-- <vex-widget-previous-months 
      [agencyId]="selectedAgencyId" 
      [userId]="selectedUserId"
      [monthsToShow]="6"
      class="mb-6"></vex-widget-previous-months> -->

  </div>
</div>
