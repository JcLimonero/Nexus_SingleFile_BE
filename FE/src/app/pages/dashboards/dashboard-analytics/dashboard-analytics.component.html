
<div class="w-full space-y-3 dashboard-analytics">
              <!-- Filtros unificados -->
              <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-2 sm:p-4 w-full filters-container">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 w-full">
                  <!-- Filtro por Agencia -->
                  <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full lg:w-auto">
                    <mat-form-field appearance="outline" class="w-full sm:w-48 lg:w-48">
                      <mat-label>Agencia</mat-label>
                      <mat-select 
                        [value]="selectedAgencyId" 
                        (selectionChange)="onAgencyChange($event.value)"
                        [disabled]="loading || !hasAgencies()">
                        <mat-option [value]="null">Todas las agencias</mat-option>
                        <mat-option 
                          *ngFor="let agency of agencies; trackBy: trackByAgencyId" 
                          [value]="agency.Id">
                          {{ agency.Name }}
                        </mat-option>
                      </mat-select>
                      <mat-hint *ngIf="loading">Cargando...</mat-hint>
                      <mat-hint *ngIf="!loading && !hasAgencies()">Sin agencias</mat-hint>
                    </mat-form-field>

                    <!-- Filtro por Usuario -->
                    <mat-form-field appearance="outline" class="w-full sm:w-64 lg:w-96">
                      <mat-label>Usuario</mat-label>
                      <mat-select 
                        #userSelect
                        [value]="selectedUserId" 
                        (selectionChange)="onUserChange($event.value)"
                        [disabled]="loading || !hasUsers() || isUserFilterDisabled">
                        <mat-option [value]="null">Todos los usuarios</mat-option>
                        <mat-option 
                          *ngFor="let user of users; trackBy: trackByUserId" 
                          [value]="user.Id">
                          {{ user.Name }}
                        </mat-option>
                      </mat-select>
                      <mat-hint *ngIf="loading">Cargando...</mat-hint>
                      <mat-hint *ngIf="!loading && !hasUsers()">Sin usuarios</mat-hint>
                      <mat-hint *ngIf="isUserFilterDisabled">Filtro deshabilitado para su rol</mat-hint>
                    </mat-form-field>
                  </div>
                  
                  <!-- Filtros de Fechas - OCULTOS -->
                  <!--
                  <div class="flex items-center space-x-2">
                    <div class="flex flex-wrap gap-1">
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === '7d'"
                        (click)="setLast7Days()">
                        7d
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === '30d'"
                        (click)="setLast30Days()">
                        30d
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === '90d'"
                        (click)="setLast90Days()">
                        90d
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === 'thisMonth'"
                        (click)="setThisMonth()">
                        Este mes
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === 'lastMonth'"
                        (click)="setLastMonth()">
                        Mes pasado
                      </button>
                      <button 
                        mat-stroked-button 
                        size="small"
                        class="text-xs px-2 py-1"
                        [class.mat-primary]="activeDateRange === 'thisYear'"
                        (click)="setThisYear()">
                        Este año
                      </button>
                    </div>
                    
                    <button 
                      mat-icon-button 
                      size="small"
                      class="toggle-button"
                      (click)="toggleManualDateInputs()"
                      [matTooltip]="showManualDateInputs ? 'Ocultar fechas manuales' : 'Mostrar fechas manuales'">
                      <mat-icon class="arrow-icon" [class.expanded]="showManualDateInputs">
                        {{ showManualDateInputs ? 'keyboard_arrow_up' : 'keyboard_arrow_down' }}
                      </mat-icon>
                    </button>
                    
                    <button 
                      mat-icon-button 
                      color="primary" 
                      size="small"
                      (click)="searchData()"
                      matTooltip="Buscar con filtros actuales">
                      <mat-icon>search</mat-icon>
                    </button>
                    
                    <button 
                      *ngIf="hasDateRange()"
                      mat-icon-button 
                      color="warn" 
                      size="small"
                      (click)="clearDateRange()"
                      matTooltip="Limpiar filtro de fechas">
                      <mat-icon>clear</mat-icon>
                    </button>
                  </div>
                  -->
                  </div>
                </div>
                
                <!-- Selectores de fecha manuales - OCULTOS -->
                <!--
                <div *ngIf="showManualDateInputs" class="grid grid-cols-2 gap-2 mt-4 manual-date-inputs">
                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Inicio</mat-label>
                    <input 
                      matInput 
                      [matDatepicker]="startPicker"
                      formControlName="startDate"
                      placeholder="Fecha inicio">
                    <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                    <mat-datepicker #startPicker></mat-datepicker>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="compact-field">
                    <mat-label>Fin</mat-label>
                    <input 
                      matInput 
                      [matDatepicker]="endPicker"
                      formControlName="endDate"
                      placeholder="Fecha fin">
                    <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                    <mat-datepicker #endPicker></mat-datepicker>
                  </mat-form-field>
                </div>
                -->
              </div>

  <!-- Estado de carga -->
  <div *ngIf="loading" class="flex justify-center py-12">
    <div class="text-center">
      <mat-icon class="text-4xl text-gray-400 mb-4" svgIcon="mat:hourglass_empty"></mat-icon>
      <p class="text-gray-600">Cargando datos de analytics...</p>
    </div>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
    <mat-icon class="text-red-500 mb-2" svgIcon="mat:error"></mat-icon>
    <p class="text-red-600">{{ error }}</p>
    <button mat-button color="primary" (click)="loadDashboardData()">
      Reintentar
    </button>
  </div>

  <!-- Dashboard principal -->
  <div *ngIf="!loading && !error">
    
    <!-- ===== SECCIÓN 1: MÉTRICAS PRINCIPALES ===== -->
    <div class="dashboard-section">
      <h2 class="section-title text-xl font-semibold text-gray-800 flex items-center">
        <mat-icon class="mr-2 text-blue-600">dashboard</mat-icon>
        Métricas Principales
      </h2>
      
      <!-- Métricas específicas de agencia y expedientes liberados -->
      <div class="metrics-main-grid">
        <!-- 1. Expedientes del Día -->
        <div class="widget-container">
          <vex-widget-today-cases 
            [agencyId]="selectedAgencyId"></vex-widget-today-cases>
        </div>

        <!-- 2. Expedientes Totales -->
        <div class="widget-container">
          <vex-widget-total-cases 
            [agencyId]="selectedAgencyId"></vex-widget-total-cases>
        </div>

        <!-- 3. Expedientes Liberados Totales -->
        <div class="widget-container">
          <vex-widget-total-liberated 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-total-liberated>
        </div>

        <!-- 4. Expedientes del Mes -->
        <div class="widget-container">
          <vex-widget-monthly-cases 
            [agencyId]="selectedAgencyId"></vex-widget-monthly-cases>
        </div>

        <!-- 5. Expedientes Liberados del Mes Actual -->
        <div class="widget-container">
          <vex-widget-current-month-liberated 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-current-month-liberated>
        </div>

        <!-- 6. Usuarios Activos -->
        <div class="widget-container">
          <vex-widget-agency-users 
            [agencyId]="selectedAgencyId"></vex-widget-agency-users>
        </div>
      </div>
    </div>

    <!-- ===== SECCIÓN 2: ANÁLISIS TEMPORAL ===== -->
    <div class="dashboard-section">
      <h2 class="section-title text-xl font-semibold text-gray-800 flex items-center">
        <mat-icon class="mr-2 text-green-600">trending_up</mat-icon>
        Análisis Temporal
      </h2>
      
      <!-- Gráficos de análisis temporal en la misma fila -->
      <div class="temporal-grid">
        <!-- Gráfico de tendencia de expedientes -->
        <div class="chart-container">
          <vex-widget-trend-chart 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-trend-chart>
        </div>

        <!-- Widget de Expedientes por Día - Semana Actual -->
        <div class="chart-container">
          <vex-widget-weekly-chart 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-weekly-chart>
        </div>
      </div>
    </div>

    <!-- ===== SECCIÓN 3: DISTRIBUCIÓN Y ESTADOS ===== -->
    <div class="dashboard-section">
      <h2 class="section-title text-xl font-semibold text-gray-800 flex items-center">
        <mat-icon class="mr-2 text-purple-600">pie_chart</mat-icon>
        Distribución y Estados
      </h2>
      
      <!-- Widgets de Distribución en la misma fila -->
      <div class="distribution-grid mb-4">
        <!-- Distribución de expedientes por proceso -->
        <div class="widget-container">
          <vex-widget-process-distribution 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-process-distribution>
        </div>

        <!-- Métricas de distribución de expedientes -->
        <div class="widget-container">
          <vex-widget-distribution-metrics-donut 
            [agencyId]="selectedAgencyId"></vex-widget-distribution-metrics-donut>
        </div>
      </div>

      <!-- Widgets de Estatus en la misma fila -->
      <div class="status-grid">
        <!-- Distribución de expedientes por estatus -->
        <div class="widget-container">
          <vex-widget-status-distribution 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-status-distribution>
        </div>

        <!-- Distribución de expedientes por estatus - Mes Actual -->
        <div class="widget-container">
          <vex-widget-current-month-status 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-current-month-status>
        </div>

        <!-- Widget de Estatus Histórico -->
        <div class="widget-container">
          <vex-widget-historical-status 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-historical-status>
        </div>
      </div>
    </div>

    <!-- ===== SECCIÓN 4: ANÁLISIS DE RENDIMIENTO Y PERÍODOS DE ATENCIÓN ===== -->
    <div class="dashboard-section">
      <h2 class="section-title text-xl font-semibold text-gray-800 flex items-center">
        <mat-icon class="mr-2 text-orange-600">analytics</mat-icon>
        Análisis de Rendimiento y Períodos de Atención
      </h2>
      
      <!-- Widgets de rendimiento y atención en la misma fila -->
      <div class="performance-grid">
        <!-- Widget de Distribución por Asesor -->
        <div class="chart-container">
          <vex-widget-advisor-distribution 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-advisor-distribution>
        </div>

        <!-- Widget de Período de Atención de Expedientes -->
        <div class="chart-container">
          <vex-widget-attention-period 
            [agencyId]="selectedAgencyId" 
            [userId]="selectedUserId"></vex-widget-attention-period>
        </div>
      </div>

      <!-- Widget de Período de Atención - Mes Actual -->
      <div class="chart-container">
        <vex-widget-current-month-attention 
          [agencyId]="selectedAgencyId" 
          [userId]="selectedUserId"></vex-widget-current-month-attention>
      </div>
    </div>

    <!-- Widget de Meses Anteriores - OCULTO -->
    <!-- <vex-widget-previous-months 
      [agencyId]="selectedAgencyId" 
      [userId]="selectedUserId"
      [monthsToShow]="6"
      class="mb-6"></vex-widget-previous-months> -->

  </div>
