<div class="integracion-container">

  <!-- Filtros de Agencia y Cliente -->
  <div class="filters-section mb-2">
    <mat-card class="bg-white rounded-lg shadow-sm border border-gray-200">
      <mat-card-content class="p-2">
        <div class="flex items-center justify-between gap-3">
          <!-- Filtro de Agencia -->
          <div class="flex items-center space-x-3">
            <mat-form-field appearance="outline" class="min-w-48">
              <mat-label>Agencia</mat-label>
              <mat-select 
                [value]="selectedAgencyId" 
                (selectionChange)="onAgencyChange($event.value)"
                [disabled]="agenciesLoading || !hasAgencies()">
                <mat-option [value]="null">Todas las agencias</mat-option>
                <mat-option 
                  *ngFor="let agency of agencies; trackBy: trackByAgencyId" 
                  [value]="agency.Id">
                  {{ agency.Name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Filtro de Cliente y Botones -->
          <div class="flex items-center space-x-3 flex-1">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Buscar Cliente</mat-label>
              <input 
                matInput 
                [(ngModel)]="clientSearchTerm"
                (keyup.enter)="searchClients()"
                placeholder="Buscar por número de cliente o nombre completo"
                autocomplete="off">
            </mat-form-field>
            
            <!-- Contenedor de botones alineados -->
            <div class="flex items-center space-x-2">
              <!-- Botón de buscar -->
              <button 
                mat-raised-button 
                color="primary" 
                (click)="searchClients()"
                [disabled]="clientsLoading || clientSearchTerm.trim().length < 3"
                matTooltip="Buscar cliente"
                style="height: 40px; min-height: 40px;">
                <mat-icon>search</mat-icon>
                Buscar
              </button>
              
              <!-- Botón de limpiar búsqueda -->
              <button 
                *ngIf="clientSearchTerm"
                mat-raised-button 
                color="warn" 
                (click)="clearClientSearch()"
                matTooltip="Limpiar búsqueda"
                style="height: 40px; min-height: 40px;">
                <mat-icon>clear</mat-icon>
                Limpiar
              </button>
            </div>
          </div>
        </div>

        <!-- Sin resultados -->
        <div *ngIf="showClientResults && clients.length === 0 && !clientsLoading" class="mt-3 text-center py-6">
          <mat-icon class="text-gray-400 mb-2" style="font-size: 40px;">search_off</mat-icon>
          <p class="text-gray-500">No se encontraron clientes con el término de búsqueda</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Información del Cliente Seleccionado -->
  <div *ngIf="selectedClient" class="client-info-section mb-2">
    <mat-card class="bg-white rounded-lg shadow-sm border border-gray-200">
      <mat-card-header class="pb-1">
        <mat-card-title class="flex items-center text-sm">
          <mat-icon class="mr-1 text-blue-600" style="font-size: 18px;">person</mat-icon>
          Información del Cliente
        </mat-card-title>
      </mat-card-header>
      <mat-card-content class="p-2">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
          <div class="field-group">
            <label class="field-label">N° Cliente</label>
            <div class="field-value">{{ selectedClient.ndCliente || 'N/A' }}</div>
          </div>
          <div class="field-group">
            <label class="field-label">Razón Social</label>
            <div class="field-value">{{ selectedClient.razonSocial || 'N/A' }}</div>
          </div>
          <div class="field-group">
            <label class="field-label">RFC</label>
            <div class="field-value">{{ selectedClient.rfc || 'N/A' }}</div>
          </div>
          <div class="field-group">
            <label class="field-label">Correo</label>
            <div class="field-value">{{ selectedClient.email || 'N/A' }}</div>
          </div>
          <div class="field-group">
            <label class="field-label">Teléfono</label>
            <div class="field-value">{{ selectedClient.telefono || 'N/A' }}</div>
          </div>
          <div class="field-group">
            <label class="field-label">Teléfono 2</label>
            <div class="field-value">{{ selectedClient.telefono2 || 'N/A' }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Tabla de Pedidos del Cliente -->
  <div *ngIf="selectedClient" class="files-section mb-2">
    <mat-card class="bg-white rounded-lg shadow-sm border border-gray-200">
      <mat-card-header class="pb-1">
        <mat-card-title class="flex items-center justify-between text-sm">
          <div class="flex items-center">
            <mat-icon class="mr-1 text-green-600" style="font-size: 18px;">description</mat-icon>
            Pedidos en Integración
          </div>
          <button 
            mat-icon-button 
            color="primary"
            (click)="agregarPedidoIntegracion()"
            matTooltip="Agregar nuevo pedido de integración"
            *ngIf="isManagerOrAdmin">
            <mat-icon style="font-size: 18px;">add</mat-icon>
          </button>
        </mat-card-title>
      </mat-card-header>
      
      <!-- Buscador de pedidos -->
      <div class="px-2 pb-2">
        <div class="flex items-center space-x-2">
          <mat-form-field appearance="outline" class="flex-1">
            <mat-label>Buscar pedido</mat-label>
            <input 
              matInput 
              [(ngModel)]="orderSearchTerm"
              (input)="onOrderSearchChange()"
              placeholder="Buscar por número de pedido, inventario, proceso, operación, vehículo, modelo, VIN o agencia"
              autocomplete="off">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
          
          <button 
            *ngIf="orderSearchTerm"
            mat-icon-button 
            color="warn"
            (click)="clearOrderSearch()"
            matTooltip="Limpiar búsqueda">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>
      <mat-card-content class="p-2">
        <!-- Loading spinner -->
        <div *ngIf="filesLoading" class="flex justify-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
        </div>

        <!-- Tabla de pedidos -->
        <div *ngIf="!filesLoading" class="overflow-x-auto">
          <table mat-table [dataSource]="paginatedFiles" class="w-full files-table">
            <!-- Número de Pedido -->
            <ng-container matColumnDef="numeroPedido">
              <th mat-header-cell *matHeaderCellDef>N° Pedido</th>
              <td mat-cell *matCellDef="let file">
                <div class="flex items-center">
                  <mat-icon class="mr-1 text-blue-600" style="font-size: 14px;">receipt</mat-icon>
                  <span class="font-medium">{{ file.numeroPedido }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Número de Inventario -->
            <ng-container matColumnDef="numeroInventario">
              <th mat-header-cell *matHeaderCellDef>N° Inventario</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.numeroInventario; else noInventory" class="text-sm">{{ file.numeroInventario }}</span>
                <ng-template #noInventory>
                  <span class="text-gray-400 italic text-sm">Sin inventario</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Proceso -->
            <ng-container matColumnDef="proceso">
              <th mat-header-cell *matHeaderCellDef>Proceso</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.proceso; else noProcess" class="text-sm">{{ file.proceso }}</span>
                <ng-template #noProcess>
                  <span class="text-gray-400 italic text-sm">Sin proceso</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Operación -->
            <ng-container matColumnDef="operacion">
              <th mat-header-cell *matHeaderCellDef>Operación</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.operacion; else noOperation" class="text-sm">{{ file.operacion }}</span>
                <ng-template #noOperation>
                  <span class="text-gray-400 italic text-sm">Sin operación</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Tipo de Cliente -->
            <ng-container matColumnDef="tipoCliente">
              <th mat-header-cell *matHeaderCellDef>Tipo Cliente</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.tipoCliente; else noClientType" class="text-sm">{{ file.tipoCliente }}</span>
                <ng-template #noClientType>
                  <span class="text-gray-400 italic text-sm">Sin tipo</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Vehículo -->
            <ng-container matColumnDef="vehiculo">
              <th mat-header-cell *matHeaderCellDef>Vehículo</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.vehiculo; else noVehicle" class="text-sm">{{ file.vehiculo }}</span>
                <ng-template #noVehicle>
                  <span class="text-gray-400 italic text-sm">Sin vehículo</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Año -->
            <ng-container matColumnDef="year">
              <th mat-header-cell *matHeaderCellDef>Año</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.year; else noYear" class="text-sm">{{ file.year }}</span>
                <ng-template #noYear>
                  <span class="text-gray-400 italic text-sm">-</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Modelo -->
            <ng-container matColumnDef="modelo">
              <th mat-header-cell *matHeaderCellDef>Modelo</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.modelo; else noModel" class="text-sm">{{ file.modelo }}</span>
                <ng-template #noModel>
                  <span class="text-gray-400 italic text-sm">Sin modelo</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- VIN -->
            <ng-container matColumnDef="vin">
              <th mat-header-cell *matHeaderCellDef>VIN</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.vin; else noVin" class="text-sm font-mono">{{ file.vin }}</span>
                <ng-template #noVin>
                  <span class="text-gray-400 italic text-sm">Sin VIN</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Agencia -->
            <ng-container matColumnDef="agencia">
              <th mat-header-cell *matHeaderCellDef>Agencia</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.agencia; else noAgency" class="text-sm">{{ file.agencia }}</span>
                <ng-template #noAgency>
                  <span class="text-gray-400 italic text-sm">Sin agencia</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Fecha de Registro -->
            <ng-container matColumnDef="fechaRegistro">
              <th mat-header-cell *matHeaderCellDef>Fecha Registro</th>
              <td mat-cell *matCellDef="let file">
                <span *ngIf="file.fechaRegistro; else noDate" class="text-sm">{{ file.fechaRegistro | date:'dd/MM/yyyy HH:mm' }}</span>
                <ng-template #noDate>
                  <span class="text-gray-400 italic text-sm">Sin fecha</span>
                </ng-template>
              </td>
            </ng-container>

            <!-- Acciones (solo para gerentes y administradores) -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let file">
                <button 
                  mat-icon-button 
                  [matMenuTriggerFor]="actionsMenu"
                  *ngIf="isManagerOrAdmin"
                  matTooltip="Opciones del pedido">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionsMenu="matMenu">
                  <button mat-menu-item (click)="cancelarPedido(file)">
                    <mat-icon>cancel</mat-icon>
                    <span>Cancelar</span>
                  </button>
                  <button mat-menu-item (click)="excepcionPedido(file)">
                    <mat-icon>warning</mat-icon>
                    <span>Excepción</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="filesDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: filesDisplayedColumns;" 
                class="hover:bg-gray-50 cursor-pointer"
                (click)="selectFile(row)"></tr>
          </table>
          
          <!-- Paginación -->
          <mat-paginator 
            *ngIf="!filesLoading && totalItems > 0"
            [length]="totalItems"
            [pageSize]="pageSize"
            [pageIndex]="currentPage"
            [pageSizeOptions]="[5, 10, 25, 50]"
            [showFirstLastButtons]="true"
            (page)="onPageChange($event)"
            class="mt-2">
          </mat-paginator>
        </div>

        <!-- Sin pedidos -->
        <div *ngIf="!filesLoading && files.length === 0" class="text-center py-8">
          <mat-icon class="text-gray-400 mb-2" style="font-size: 40px;">folder_open</mat-icon>
          <p class="text-gray-500">No se encontraron pedidos en estatus de integración para este cliente</p>
        </div>
        
        <!-- Sin resultados de búsqueda -->
        <div *ngIf="!filesLoading && files.length > 0 && filteredFiles.length === 0" class="text-center py-8">
          <mat-icon class="text-gray-400 mb-2" style="font-size: 40px;">search_off</mat-icon>
          <p class="text-gray-500">No se encontraron pedidos que coincidan con la búsqueda</p>
          <button 
            mat-button 
            color="primary" 
            (click)="clearOrderSearch()"
            class="mt-2">
            Limpiar búsqueda
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Sección de Documentos del Pedido Seleccionado -->
  <div *ngIf="selectedFile" class="documents-section mb-2">
    <mat-card class="bg-white rounded-lg shadow-sm border border-gray-200">
      <mat-card-header class="pb-1">
        <mat-card-title class="flex flex-col text-sm">
          <div class="flex items-center mb-1">
            <mat-icon class="mr-1 text-blue-600" style="font-size: 18px;">folder</mat-icon>
            <span class="font-semibold">Documentos Requeridos</span>
          </div>
          <div class="text-xs text-gray-600 ml-6">
            Pedido {{ selectedFile.numeroPedido }} • {{ selectedFile.proceso }} • {{ selectedFile.operacion }} • {{ selectedFile.tipoCliente }} • {{ selectedFile.modelo }} {{ selectedFile.vehiculo }} {{ selectedFile.year }} • VIN: {{ selectedFile.vin }}
          </div>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content class="p-2">
        <!-- Loading spinner -->
        <div *ngIf="documentsLoading" class="flex justify-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
        </div>

        <!-- Lista de documentos -->
        <div *ngIf="!documentsLoading" class="space-y-2">
          <div *ngFor="let document of requiredDocuments" 
               class="document-item flex items-center justify-between p-2 border border-gray-200 rounded hover:bg-gray-50">
            
            <!-- Información del documento -->
            <div class="flex items-center space-x-2 flex-1">
              <!-- Icono de estado -->
              <mat-icon [class]="getDocumentStatusColor(document.status, document.idCurrentStatus)" style="font-size: 16px;">
                {{ getDocumentStatusIcon(document.status, document.idCurrentStatus) }}
              </mat-icon>
              
                <!-- Nombre del documento -->
                <div class="flex-1">
                  <div class="font-medium text-gray-900 text-sm">{{ document.documentName }}</div>
                  <div *ngIf="document.hasExpiration === '1' && document.expirationDate" 
                       class="text-xs text-gray-500">
                    Vencimiento: {{ document.expirationDate | date:'dd/MM/yyyy' }}
                  </div>
                </div>
            </div>

            <!-- Controles de archivo -->
            <div class="flex items-center space-x-1">
              <!-- Input de archivo -->
              <div class="file-input-container">
                <input 
                  type="file" 
                  #fileInput
                  (change)="onFileSelected($event, document.documentId)"
                  accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                  class="hidden"
                  [id]="'file-' + document.documentId">
                <button 
                  mat-stroked-button 
                  (click)="fileInput.click()"
                  [disabled]="document.idCurrentStatus === '3' || document.idCurrentStatus === '4'"
                  class="text-xs">
                  <mat-icon class="mr-1" style="font-size: 14px;">attach_file</mat-icon>
                  {{ selectedFiles[document.documentId] ? selectedFiles[document.documentId].name : 'Seleccionar archivo' }}
                </button>
              </div>

              <!-- Botón Cargar -->
              <button 
                mat-raised-button 
                color="primary"
                (click)="uploadDocument(document)"
                [disabled]="!selectedFiles[document.documentId] || document.idCurrentStatus === '3' || document.idCurrentStatus === '4'"
                class="text-xs">
                <mat-icon class="mr-1" style="font-size: 14px;">upload</mat-icon>
                CARGAR
              </button>

              <!-- Botón Ver -->
              <button 
                mat-raised-button 
                color="accent"
                (click)="viewDocument(document)"
                [disabled]="!document.filePath"
                class="text-xs">
                <mat-icon class="mr-1" style="font-size: 14px;">visibility</mat-icon>
                VER
              </button>
            </div>
          </div>
        </div>

        <!-- Sin documentos -->
        <div *ngIf="!documentsLoading && requiredDocuments.length === 0" class="text-center py-8">
          <mat-icon class="text-gray-400 mb-2" style="font-size: 40px;">folder_open</mat-icon>
          <p class="text-gray-500">No se encontraron documentos requeridos para este pedido</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

</div>
