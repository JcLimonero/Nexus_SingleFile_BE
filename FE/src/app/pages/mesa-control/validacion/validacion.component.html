<div class="min-h-screen bg-gray-50 p-2">
  <style>
    /* Ocultar completamente los hints de los combos para que no ocupen espacio */
    .mat-mdc-form-field-subscript-wrapper,
    .mat-mdc-form-field-hint-wrapper,
    .mat-mdc-form-field-hint-spacer,
    .mat-mdc-form-field-bottom-align {
      display: none !important;
      height: 0 !important;
      min-height: 0 !important;
      max-height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      visibility: hidden !important;
      opacity: 0 !important;
      position: absolute !important;
      pointer-events: none !important;
    }
    
    /* Asegurar que los campos no tengan espacio residual */
    .mat-mdc-form-field {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Reducir el padding interno de los campos */
    .mat-mdc-form-field-infix {
      padding-top: 4px !important;
      padding-bottom: 4px !important;
      min-height: 16px !important;
    }
    
    /* Cambiar padding de todas las celdas de tabla de py-2 a py-0 */
    .py-2 {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Asegurar que todas las celdas de tabla no tengan padding vertical */
    th.mat-header-cell,
    td.mat-cell {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Estilos ultra compactos para TODOS los combos del filtro */
    .filtro-container .mat-mdc-form-field-infix {
      padding-top: 1px !important;
      padding-bottom: 1px !important;
      min-height: 8px !important;
      height: 8px !important;
      max-height: 8px !important;
    }
    
    /* Forzar altura en todos los campos del filtro */
    .filtro-container .mat-mdc-form-field {
      height: 32px !important;
      min-height: 32px !important;
      max-height: 32px !important;
    }
    
    /* Reducir altura del wrapper del campo */
    .filtro-container .mat-mdc-text-field-wrapper {
      height: 32px !important;
      min-height: 32px !important;
      max-height: 32px !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Estilos específicos para todos los mat-select dentro del filtro */
    .filtro-container .mat-mdc-select {
      height: 24px !important;
      min-height: 24px !important;
      max-height: 24px !important;
      line-height: 24px !important;
    }
    
    /* Reducir altura de las opciones del select */
    .filtro-container .mat-mdc-option {
      height: 28px !important;
      min-height: 28px !important;
      max-height: 28px !important;
      line-height: 28px !important;
    }
    
    /* Estilos ultra compactos para el combo de fase */
    .combo-fase .mat-mdc-form-field-infix {
      padding-top: 1px !important;
      padding-bottom: 1px !important;
      min-height: 8px !important;
      height: 8px !important;
      max-height: 8px !important;
    }
    
    .combo-fase .mat-mdc-form-field {
      height: 32px !important;
      min-height: 32px !important;
      max-height: 32px !important;
    }

    /* Animación de spinner para el botón de recarga */
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    
    .combo-fase .mat-mdc-text-field-wrapper {
      height: 32px !important;
      min-height: 32px !important;
      max-height: 32px !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }
    
    .combo-fase .mat-mdc-select {
      height: 24px !important;
      min-height: 24px !important;
      max-height: 24px !important;
      line-height: 24px !important;
    }
    
    .combo-fase .mat-mdc-option {
      height: 28px !important;
      min-height: 28px !important;
      max-height: 28px !important;
      line-height: 28px !important;
    }
    
    /* Estilos para iconos de la sección de filtros de estado - reducidos a la mitad */
    .filtros-estado .mat-icon {
      font-size: 14px !important;
      width: 14px !important;
      height: 14px !important;
      line-height: 14px !important;
    }
    
    .filtros-estado .mat-icon-button {
      width: 24px !important;
      height: 24px !important;
      min-width: 24px !important;
      min-height: 24px !important;
      line-height: 24px !important;
    }
    
    /* Reducir también el padding del contenedor del filtro */
    .filtro-container {
      padding: 8px !important;
      margin-bottom: 16px !important;
    }
    
    /* Reducir el gap entre elementos del grid */
    .filtro-grid {
      gap: 1px !important;
    }
    
    /* Estilos ultra compactos para los filtros principales */
    .filtro-container .mat-mdc-form-field-infix {
      padding-top: 1px !important;
      padding-bottom: 1px !important;
      min-height: 8px !important;
      height: 8px !important;
      max-height: 8px !important;
    }
    
    .filtro-container .mat-mdc-form-field {
      height: 32px !important;
      min-height: 32px !important;
      max-height: 32px !important;
    }
    
    .filtro-container .mat-mdc-text-field-wrapper {
      height: 32px !important;
      min-height: 32px !important;
      max-height: 32px !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }
    
    .filtro-container .mat-mdc-select {
      height: 24px !important;
      min-height: 24px !important;
      max-height: 24px !important;
      line-height: 24px !important;
    }
    
    .filtro-container .mat-mdc-option {
      height: 28px !important;
      min-height: 28px !important;
      max-height: 28px !important;
      line-height: 28px !important;
    }
  </style>
  
          <!-- Header Principal -->
    <div class="mb-2">
      <!-- Título y detalle removidos - ahora se muestran en el toolbar -->
    </div>

        <!-- Filtros Principales -->
    <div class="bg-white rounded-lg shadow-sm border p-1 mb-2 filtro-container">
      <div class="flex flex-wrap items-center justify-between gap-2.5 filtro-grid">
        <mat-form-field appearance="outline" class="min-w-0 mr-2.5" style="width: 250px;">
          <mat-label>Agencia</mat-label>
          <mat-select [(ngModel)]="selectedAgency" [disabled]="loadingAgencias || agencias.length === 0" (selectionChange)="onAgenciaChange()">
            <mat-option *ngIf="loadingAgencias" value="" disabled>
              <mat-spinner diameter="16" class="inline mr-2"></mat-spinner>
              Cargando agencias...
            </mat-option>
            <mat-option *ngIf="!loadingAgencias && agencias.length === 0" value="" disabled>
              No hay agencias disponibles (debugging)
            </mat-option>
            <mat-option *ngFor="let agencia of agencias" [value]="agencia.Id">
              {{ agencia.Name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="min-w-0 mr-2.5" style="width: 206px;">
          <mat-label>Proceso</mat-label>
          <mat-select [(ngModel)]="selectedProcess" [disabled]="loadingProcesos || procesos.length === 0" (selectionChange)="onProcesoChange()">
            <mat-option *ngIf="loadingProcesos" value="" disabled>
              <mat-spinner diameter="16" class="inline mr-2"></mat-spinner>
              Cargando procesos...
            </mat-option>
            <mat-option *ngIf="!loadingProcesos && procesos.length === 0" value="" disabled>
              No hay procesos disponibles
            </mat-option>
            <mat-option *ngFor="let proceso of procesos" [value]="proceso.Id">
              {{ proceso.Name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="min-w-0 mr-2.5" style="width: 206px;">
          <mat-label>Fase</mat-label>
          <mat-select [(ngModel)]="selectedFase" (selectionChange)="onFaseChange()">
            <mat-option value="">Todas las fases</mat-option>
            <mat-option value="integracion">Integración</mat-option>
            <mat-option value="liquidacion">Liquidación</mat-option>
            <mat-option value="liberacion">Liberación</mat-option>
            <mat-option value="excepcion">Excepción</mat-option>
            <mat-option value="liberado">Liberado</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Buscador integrado -->
        <mat-form-field appearance="outline" class="flex-1 min-w-0 mr-2.5">
          <mat-label>Buscar</mat-label>
          <input matInput 
                 [(ngModel)]="searchTerm" 
                 (input)="onSearchChange()"
                 placeholder="Pedido, cliente o nombre"
                 class="text-sm">
          <mat-icon matSuffix class="text-gray-400">search</mat-icon>
        </mat-form-field>

        <div class="flex items-center justify-center gap-2">
          <button mat-icon-button
                  *ngIf="searchTerm"
                  (click)="clearSearch()"
                  class="text-gray-500 hover:text-red-600 !w-8 !h-8"
                  matTooltip="Limpiar búsqueda">
            <mat-icon>clear</mat-icon>
          </button>
          <button mat-icon-button
                  class="text-gray-600 hover:text-blue-600 transition-colors"
                  (click)="recargarDatos()"
                  [disabled]="loading || loadingAgencias || loadingProcesos"
                  matTooltip="Recargar datos">
            <mat-icon [class.animate-spin]="loading || loadingAgencias || loadingProcesos">refresh</mat-icon>
          </button>
        </div>
      </div>

      <!-- Contador de resultados de búsqueda -->
      <div class="text-xs text-gray-500 mt-1 px-1" *ngIf="searchTerm">
        Mostrando {{ clientesDataSource.data.length }} de {{ totalRecords }} registros
      </div>
    </div>

      <!-- Tabla de Clientes/Procesos -->
      <mat-card class="mb-2">
        <div class="p-2">
          <!-- Título de tabla removido -->
          
          
          <div *ngIf="loading" class="flex justify-center items-center py-8">
            <mat-spinner diameter="40"></mat-spinner>
          </div>

                        <table mat-table [dataSource]="clientesDataSource" matSort class="w-full" *ngIf="!loading">
            <!-- Columna ND Cliente -->
            <ng-container matColumnDef="ndCliente">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-40 py-0 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center justify-center gap-1">ND Cliente <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-0 text-xs font-medium text-gray-900">
                <div class="flex items-center">
                  <span class="text-yellow-500 mr-1">★</span>
                  {{ item.ndCliente }}
                </div>
              </td>
            </ng-container>

            <!-- Columna ND Pedido -->
            <ng-container matColumnDef="ndPedido">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-40 py-0 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center justify-center gap-1">ND Pedido <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-0 text-xs font-medium text-gray-900">
                {{ item.ndPedido }}
              </td>
            </ng-container>

            <!-- Columna Cliente -->
            <ng-container matColumnDef="cliente">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="min-w-0 flex-1 py-0 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center gap-1">Cliente <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-0 text-xs text-gray-700">
                {{ item.cliente }}
              </td>
            </ng-container>

            <!-- Columna Proceso -->
            <ng-container matColumnDef="proceso">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-48 py-1 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center justify-center gap-1">Proceso <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-1 text-xs text-gray-700">
                {{ item.proceso }}
              </td>
            </ng-container>

            <!-- Columna Operación -->
            <ng-container matColumnDef="operacion">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-48 py-1 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center justify-center gap-1">Operación <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-1 text-xs text-gray-700">
                {{ item.operacion }}
              </td>
            </ng-container>

            <!-- Columna Fase -->
            <ng-container matColumnDef="fase">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-28 py-0 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center justify-center gap-1">Fase <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-0 text-center">
                <span class="px-2 py-1 rounded-full text-xs font-medium"
                      [ngClass]="{
                        'bg-green-100 text-green-800': item.fase === 'Integración',
                        'bg-blue-100 text-blue-800': item.fase === 'Liquidación',
                        'bg-purple-100 text-purple-800': item.fase === 'Liberación',
                        'bg-red-100 text-red-800': item.fase === 'Excepción',
                        'bg-indigo-100 text-indigo-800': item.fase === 'Liberado'
                      }">
                  {{ item.fase }}
                </span>
              </td>
            </ng-container>

            <!-- Columna Registro -->
            <ng-container matColumnDef="registro">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="w-40 py-1 bg-gray-50 text-xs font-medium text-gray-700">
                <span class="flex items-center justify-center gap-1">Registro <mat-icon class="text-gray-400">unfold_more</mat-icon></span>
              </th>
              <td mat-cell *matCellDef="let item" class="py-1 text-xs text-gray-700 text-center">
                {{ item.registro }}
              </td>
            </ng-container>

                              <tr mat-header-row *matHeaderRowDef="clientesDisplayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: clientesDisplayedColumns;" 
                      (click)="onClienteSelect(row)"
                      [ngClass]="{'!min-h-0 !h-10 cursor-pointer hover:bg-blue-50 transition-colors': true, 'bg-blue-100 border-l-4 border-blue-500': selectedCliente?.ndCliente === row.ndCliente}"></tr>
                </table>
                
                <!-- Paginador -->
                <mat-paginator 
                  [length]="totalRecords"
                  [pageSize]="pageSize"
                  [pageSizeOptions]="pageSizeOptions"
                  [pageIndex]="currentPage"
                  (page)="onPageChange($event)"
                  (pageSizeChange)="onPageSizeChange($event)"
                  showFirstLastButtons
                  aria-label="Seleccionar página de clientes">
                </mat-paginator>
        </div>
      </mat-card>


      <!-- Tabla de Documentos -->
      <mat-card class="mb-4">
        <div class="p-2">
          <!-- Título de tabla removido -->
          
          <!-- Mensaje cuando no hay cliente seleccionado -->
          <div *ngIf="!selectedCliente" class="flex justify-center items-center py-8 text-gray-500">
            <div class="text-center">
              <mat-icon class="text-gray-400 text-4xl mb-2">info</mat-icon>
              <p class="text-sm">Selecciona un cliente/pedido de la tabla superior para ver sus documentos</p>
            </div>
          </div>
          
          <!-- Loading cuando se están cargando documentos -->
          <div *ngIf="loading && selectedCliente" class="flex justify-center items-center py-8">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
          
          <!-- Tabla de documentos cuando hay cliente seleccionado -->
          <div *ngIf="selectedCliente && !loading">
            <!-- Información de documentos -->
            <div class="mb-3 px-2 py-1 bg-gray-50 border-b text-sm text-gray-600">
              Mostrando {{ documentosDataSource.length }} documentos para el cliente {{ selectedCliente.cliente }} (Pedido: {{ selectedCliente.ndPedido }})
            </div>

                      <table mat-table [dataSource]="documentosDataSource" matSort class="w-full" *ngIf="documentosDataSource.length > 0">
            <!-- Columna Proceso -->
            <ng-container matColumnDef="proceso">
              <th mat-header-cell *matHeaderCellDef class="w-32 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Proceso
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-xs text-gray-700">
                {{ item.proceso }}
              </td>
            </ng-container>

            <!-- Columna Fase -->
            <ng-container matColumnDef="fase">
              <th mat-header-cell *matHeaderCellDef class="w-28 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Fase
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-xs text-gray-700">
                {{ item.fase }}
              </td>
            </ng-container>

            <!-- Columna Documento -->
            <ng-container matColumnDef="documento">
              <th mat-header-cell *matHeaderCellDef class="min-w-0 flex-1 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Documento
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-xs text-gray-700">
                {{ item.documento }}
              </td>
            </ng-container>

            <!-- Columna Estatus -->
            <ng-container matColumnDef="estatus">
              <th mat-header-cell *matHeaderCellDef class="w-20 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Estatus
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-center">
                <div class="w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center mx-auto">
                  <span class="text-white text-xs font-bold">i</span>
                </div>
              </td>
            </ng-container>

            <!-- Columna Ver -->
            <ng-container matColumnDef="ver">
              <th mat-header-cell *matHeaderCellDef class="w-16 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Ver
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-center">
                <button mat-icon-button color="primary" class="!w-6 !h-6 !min-h-6 !p-0">
                  <mat-icon class="!text-sm">visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Columna Validar -->
            <ng-container matColumnDef="validar">
              <th mat-header-cell *matHeaderCellDef class="w-20 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Validar
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-center">
                <div class="relative">
                  <button mat-icon-button class="!w-6 !h-6 !min-h-6 !p-0 text-gray-400">
                    <mat-icon class="!text-sm">mail</mat-icon>
                  </button>
                  <mat-icon *ngIf="item.validado" class="absolute -top-1 -right-1 text-green-600 text-sm">check_circle</mat-icon>
                </div>
              </td>
            </ng-container>

            <!-- Columna Eliminar -->
            <ng-container matColumnDef="eliminar">
              <th mat-header-cell *matHeaderCellDef class="w-20 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Eliminar
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-center">
                <button mat-icon-button color="warn" class="!w-6 !h-6 !min-h-6 !p-0">
                  <mat-icon class="!text-sm">remove_circle</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Columna Requerido -->
            <ng-container matColumnDef="requerido">
              <th mat-header-cell *matHeaderCellDef class="w-24 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Requerido
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-center">
                <mat-checkbox [checked]="item.requerido" class="!w-4 !h-4"></mat-checkbox>
              </td>
            </ng-container>

            <!-- Columna Fecha -->
            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef class="w-28 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Fecha
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-xs text-gray-700 text-center">
                {{ item.fecha }}
              </td>
            </ng-container>

            <!-- Columna Comentario -->
            <ng-container matColumnDef="comentario">
              <th mat-header-cell *matHeaderCellDef class="w-32 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Comentario
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-xs text-gray-700">
                {{ item.comentario }}
              </td>
            </ng-container>

            <!-- Columna Asignado -->
            <ng-container matColumnDef="asignado">
              <th mat-header-cell *matHeaderCellDef class="w-28 py-2 bg-gray-50 text-xs font-medium text-gray-700">
                Asignado
              </th>
              <td mat-cell *matCellDef="let item" class="py-2 text-xs text-gray-700">
                {{ item.asignado }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="documentosDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: documentosDisplayedColumns;" class="!min-h-0 !h-10"></tr>
          </table>
          
          <!-- Mensaje cuando no hay documentos -->
          <div *ngIf="documentosDataSource.length === 0" class="flex justify-center items-center py-8 text-gray-500">
            <div class="text-center">
              <mat-icon class="text-gray-400 text-4xl mb-2">folder_open</mat-icon>
              <p class="text-sm">No hay documentos disponibles para este cliente y pedido</p>
            </div>
          </div>
          </div>
        </div>
      </mat-card>

                    <!-- Dashboard de estadísticas removido -->
    </div>
